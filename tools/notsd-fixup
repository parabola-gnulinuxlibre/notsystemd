#!/usr/bin/env bash
# Copyright (C) 2015-2016  Luke Shumaker

main() {
	set -e
	set -o pipefail
	export LC_COLLATE=C

	# We wrap the programs called by xargs with `sh` because xargs only exits early
	# if the status is 255, but we want to exit early for all non-zero statuses.
	# We use xargs instead of `find -exec` because `-exec` won't do much of
	# anything useful with the exit status.

	# Makefiles
	find "$@" -type f -name Makefile -print0 |
		xargs -r0 sh -c "$0--makefiles \"\$@\" || exit 255" --

	# GNUmakefiles
	find "$@" -type l -name GNUmakefile -delete
	find "$@" -name Makefile -printf '%h\0' |
		xargs -r0 realpath -z --relative-to=. -- |
		grep -Zz -vFx . |
		xargs -r0 -n1 sh -c 'ln -s -r -t "$1" GNUmakefile || exit 255' --

	# C includes
	rm -rf -- "$0"--includes.cache
	find "$@" \( -name '*.h' -o -name '*.c' -o -name '*.gperf' -o -name '*.gperf.m4' \) -type f -print0 |
		xargs -r0 sh -c "$0--includes \"\$@\" || exit 255" --
	rm -rf -- "$0"--includes.cache
}

main "$@"
